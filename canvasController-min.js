class CanvasController{constructor(e){const t=this;t.events={},t._isPaused=!1,t._evt={mouse:[],dimensions:[]},t._vars={},t._physX=[],t.speedMult=1,t.validate(e)}validate(e){const t=this,s=e.id;let{fps:i,grid:r,background:n,items:o}=e,{draw:a,cellSize:h,lineWidth:c,color:l,lineDash:d}="object"==typeof r?r:{};if(void 0===s||!document.getElementById(s))return;t.id=s,i="number"==typeof i?i:60,t.fps=(()=>i),a="boolean"==typeof a&&a,h="number"==typeof h?h:100,c="number"==typeof c?c:1,l="string"==typeof l?l:"white",d=void 0!==d&&Array.isArray(d)&&2==d.length&&"number"==typeof d.reduce((e,t)=>e+t)?d:[0,0],t.grid=new CanvasGrid({draw:a,cellSize:h,lineWidth:c,strokeStyle:l,lineDash:d}),t.items=[],t.background="string"==typeof n?n:"black";const u=t.getCanvas().getContext("2d",{alpha:!1});t._2D=(()=>u);for(let e in o)t.addItem(o[e]);t.start()}bg(){return this.background}_bg(e){this.background=e}addItem(e){const t=this,s=t.items.length,i={fillRect:4,arc:5},{shape:r,dimensions:n,physX:o,events:a}="object"==typeof e?e:{};let h="object"==typeof e.color?h:{},{fill:c,stroke:l}="object"==typeof h?h:{},{enable:d,gravity:u,bounce:y,friction:m,acc:f}="object"==typeof o?o:{},p={};if(Object.keys(i).includes(r)&&n.length==i[r]){h.fill="string"==typeof c?c:"black",h.stroke="string"==typeof l?l:"black",(d="boolean"==typeof d&&d)&&(t._physX.push(s),o.enable=d,o.gravity="number"==typeof u?u:9.81,o.bounce="number"==typeof y?y:.4,o.friction="number"==typeof m?m:0,o.acc=Array.isArray(f)&&2==f.length&&"number"==typeof f.reduce((e,t)=>e+t)?f:[0,0],o.isDragged=!1);const e=t.validateEvents(a);t.registerEvents(s,e),p={shape:r,dimensions:n,color:h,physX:o,events:e},t.items.push(new CanvasItem(p))}}validateEvents(e){const t=[],s=["mousedown","mouseup","mouseover","mouseout","dblclick","click","mousemove","drag"],i=["x","y"];for(let r in e){const n=e[r],{type:o}=n;let{callback:a,assist:h,dragAxis:c,assists:l,bindself:d}=n;const u="string"==typeof o?s.indexOf(o):-1;if(d="boolean"!=typeof d||d,a="function"==typeof a?a:function(){},-1!=u)if(u<7)h="number"==typeof h?h:0,t.push({type:o,assist:h,callback:a,bindself:d});else if(7==u){l=Array.isArray(l)?l:[15,1e3,2e3];let e=[],[s,r,n]=l;switch(s="number"==typeof s?s:15,r="number"==typeof r?r:1e3,n="number"==typeof n?n:2e3,c="string"==typeof c&&i.includes(c)?c:"",e.push({type:"mousedown",assist:s,callback:function(e){e._isDragged(!0),this.disableCursor()}},{type:"mouseup",assist:n,callback:function(e){e._isDragged(!1),this.enableCursor()}}),c){case"x":e.push({type:"mousemove",assist:r,callback:function(e){e.isDragged()&&e._x(this.centerMouseX())},bindself:!0});break;case"y":e.push({type:"mousemove",assist:r,callback:function(e){e.isDragged()&&e._y(this.centerMouseY())},bindself:!0});break;default:e.push({type:"mousemove",assist:r,callback:function(e){if(e.isDragged()){const[t,s]=this.centerMouse();e._xy({x:t,y:s})}},bindself:!0})}t.push(...e)}}return t}registerEventType(e){const t=this,s=t.events;"string"==typeof e&&void 0===s[e]&&(t.events[e]=[],t.addHandler(e))}registerEvents(e,t){const s=this,i=t.map(e=>e.type);i.forEach(e=>s.registerEventType(e));for(let r in t){t[r];s.events[i[r]].push([e,r])}}addHandler(e){const t=this,s=t.eventHandler;t.getCanvas().addEventListener(e,s.bind(t))}eventHandler(e){const t=this,s=[e.clientX,e.clientY],i=e.type,r=t.events[i];for(let i in r){const n=r[i][0],o=r[i][1],a=t.items[n],[h,c]=a.xy(),l=a.shape,d=a.events[o],u="number"==typeof d.assist?d.assist:0;let y,m,f,[p,b]=a.abc();"arc"==l?(y=[h-p-u,h+p+u],m=[c-p-u,c+p+u],b=p,f=t.checkMouse({mouse:s,shape:l,center:[h,c],radius:p,assist:u})):(y=[h-u,h+p+u],m=[c-u,c+b+u],f=t.checkMouse({mouse:s,shape:l,bordersX:y,bordersY:m})),f&&(e.mouse={x:e.clientX,y:e.clientY},e.id=n,e.item=a,t._evt=e,0==d.bindself?d.callback():d.callback.call(t,a,e))}}gravity(){if(!this._isPaused){const e=this,t=e._physX,s=e.fps(),[i,r]=e.client,n=(e,[t,s])=>{let i=0;return t>=e?i=-1:s<=e&&(i=1),i};for(let o in t){const a=t[o],h=e.items[a];if(h.phEnable()&&!h.isDragged()){h.phX();const{gravity:t,bounce:o,friction:a,acc:c}=h.phX(),l=h.sh(),[d,u]=h.xy(),y=e.speedMult;let m,f,p,b,g=[];if(c[0]=c[0]*(1-a/100),g[0]=d+c[0]/s*y,c[1]+=t/s*y,g[1]=u+c[1],"arc"==l){const e=h.a();m=[e,i-e],f=[e,r-e]}else{const[e,t]=h.abc();m=[0,i-e],f=[0,r-t]}const v=n(g[0],m),_=n(g[1],f);0!=v&&0==_?(p=-1==v?m[0]:m[1],h._acc(c),h._xy({x:p,y:g[1]}),h.hBounce()):0!=_&&0==v?(p=-1==_?f[0]:f[1],h._xy({x:g[0],y:p}),h.vBounce()):0!=v&&0!=_?(p=-1==v?m[0]:m[1],b=-1==_?f[0]:f[1],h.hBounce(),h.vBounce(),h._xy({x:p,y:b})):(h._acc(c),h._xy({x:g[0],y:g[1]}))}else h.isDragged()&&h._acc([0,0])}}}checkMouse({mouse:e,shape:t,bordersX:s,bordersY:i,center:r,radius:n,assist:o}){if("arc"==t){const t=Math.abs(r[0]-e[0]),s=Math.abs(r[1]-e[1]);return Math.sqrt(t**2+s**2)<=n+(o="number"==typeof o?o:0)}return(([e,t],[s,i],[r,n])=>s<=e&&e<=i&&r<=t&&t<=n)(e,s,i)}drawFrame(){const e=this,t=e.items;if(0==e._isPaused){e.canvasAdapt(),e.clearFrame(),e.drawGrid(),e.gravity();for(let s in t)e.drawItem(s)}}drawGrid(){const e=this.grid;if(1==e.dr()){const t=this,s=t._2D(),{clientWidth:i,clientHeight:r}=t.getCanvas(),n=e.cell(),o=Math.ceil(r/n),a=Math.ceil(i/n);let h=n,c=n;s.lineWidth=e.lWidth(),s.strokeStyle=e.st(),s.setLineDash(e.lDash());for(let e=1;e<a;e++)s.beginPath(),s.moveTo(h,0),s.lineTo(h,r),s.stroke(),h+=n;for(let e=1;e<o;e++)s.beginPath(),s.moveTo(0,c),s.lineTo(i,c),s.stroke(),c+=n;s.lineWidth=1,s.strokeStyle="",s.setLineDash([])}}clearFrame(){const e=this,t=e._2D(),[s,i]=e.client;t.fillStyle=e.bg(),t.fillRect(0,0,s,i)}canvasAdapt(){const e=this.getCanvas(),{clientWidth:t,clientHeight:s}=e;e.width=t,e.height=s,this.client=[t,s]}drawItem(e){const t=this._2D(),s=this.items[e],i=s.dims(),r=s.sh();switch(t.fillStyle=s.fill(),t.strokeStyle=s.stroke(),r){case"fillRect":t[r](...i);break;case"arc":t.beginPath(),t[r](...i),t.fill(),t.stroke()}}randomizeItemState(e){const t=this,s=t.items[e],i=[-15,-11,-7,7,11,15],r=[15,20,25,30,35];if("arc"==s.shape){const e=s.a(),[n,o]=t.client,a=Math.floor(Math.random()*(n-2*e))+e,h=Math.floor(Math.random()*(o-5*e))+3*e,c=Math.floor(1e3*Math.random())+500;s._gr(i[Math.floor(Math.random()*i.length)]),s._a(r[Math.floor(Math.random()*r.length)]),s._xy({x:a,y:h}),s._hAcc(c)}}setItemRandomColor(e){const t=`rgba(${Math.floor(255*Math.random())},${Math.floor(255*Math.random())},${Math.floor(255*Math.random())},0.4)`;this.items[e]._fill(t),this.items[e]._stroke(t)}centerMouseX(){return"arc"==this._evt.item.sh()?this._evt.mouse.x:this._evt.mouse.x-this._evt.item.a()/2}centerMouseY(){return"arc"==this._evt.item.sh()?this._evt.mouse.y:this._evt.mouse.y-this._evt.item.b()/2}centerMouse(){return[this.centerMouseX(),this.centerMouseY()]}disableCursor(){this.getCanvas().style.cursor="none"}enableCursor(){this.getCanvas().style.cursor=""}getCanvas(){return document.getElementById(this.id)}start(){const e=this,t=e.drawFrame;let s=0;e.drawnFrames=(()=>s),this.drawFrame(),e.refreshFrame=setInterval(function(){t.bind(this)(),s++}.bind(e),1e3/e.fps())}pause(){this._isPaused=!0}unpause(){this._isPaused=!1}stop(){clearInterval(this.refreshFrame),delete this.refreshFrame}}class CanvasGrid{constructor(e){for(let t in e)this[t]=e[t]}dr(){return this.draw}_dr(e){this.draw=e}cell(){return this.cellSize}_cell(e){this.cellSize=e}lWidth(){return this.lineWidth}_lWidth(e){this.lineWidth=e}lDash(){return this.lineDash}_lDash(e){this.lineDash=e}st(){return this.strokeStyle}_st(e){this.strokeStyle=e}}class CanvasItem{constructor(e){for(let t in e)this[t]=e[t]}sh(){return this.shape}_sh(e){this.shape=e}dims(){return this.dimensions}_dims(e){this.dimensions=e}x(){return this.dimensions[0]}_x(e){this.dimensions[0]=e}y(){return this.dimensions[1]}_y(e){this.dimensions[1]=e}xy(){return this.dimensions.slice(0,2)}_xy({x:e,y:t}){this.dimensions[0]=e,this.dimensions[1]=t}a(){return this.dimensions[2]}_a(e){this.dimensions[2]=e}b(){return this.dimensions[3]}_b(e){this.dimensions[3]=e}c(){return this.dimensions[4]}_c(e){this.dimensions[4]=e}abc(){return this.dimensions.slice(2)}color(){return this.color}_color({fill:e,stroke:t}){this.color.fill=e,this.color.stroke=t}fill(){return this.color.fill}_fill(e){this.color.fill=e}stroke(){return this.color.stroke}_stroke(e){this.color.stroke=e}phX(){return this.physX}phEnable(){return this.physX.enable}_phEnable(e){this.physX.enable=e}gr(){return this.physX.gravity}_gr(e){this.physX.gravity=e}bo(){return this.physX.bounce}_bo(e){this.physX.bounce=e}hBounce(){this.physX.acc[0]*=-this.physX.bounce}vBounce(){this.physX.acc[1]*=-this.physX.bounce}fr(){return this.physX.friction}_fr(e){this.physX.friction=e}acc(){return this.physX.acc}_acc([e,t]){this.physX.acc[0]=e,this.physX.acc[1]=t}hAcc(){return this.physX.acc[0]}_hAcc(e){this.physX.acc[0]=e}vAcc(){return this.physX.acc[1]}_vAcc(e){this.physX.acc[1]=e}isDragged(){return this.physX.isDragged}_isDragged(e){this.physX.isDragged=e}evts(){return this.events}ev(e){return this.events[e]}}