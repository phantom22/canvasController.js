class CanvasController{constructor(e){const t=this;t.events={},t._isPaused=!1,t._evt={mouse:[],dimensions:[]},t._vars={},t._physX=[],t.speedMult=1,t.validate(e)}validate(e){const t=this,s=e.id;let{fps:i,items:o,grid:n}=e;if(void 0===s||!document.getElementById(s))return;t.id=s,t.fps="number"==typeof i?i:60,t.grid="boolean"==typeof n&&n,t.items=[];const r=t.getCanvas().getContext("2d");t._2D=(()=>r);for(let e in o)t.addItem(o[e]);t.start()}addItem(e){const t=this,s=t.items.length,i={fillRect:4,arc:5},{shape:o,dimensions:n,physX:r,events:a}="object"==typeof e?e:{};let c="object"==typeof e.color?c:{},{fill:h,stroke:l}="object"==typeof c?c:{},{enable:m,gravity:d,bounce:u,friction:f,acc:p}="object"==typeof r?r:{},y={};if(Object.keys(i).includes(o)&&n.length==i[o]){c.fill="string"==typeof h?h:"black",c.stroke="string"==typeof l?l:"black",(m="boolean"==typeof m&&m)&&(t._physX.push(s),r.enable=m,r.gravity="number"==typeof d?d:9.81,r.bounce="number"==typeof u?u:.4,r.friction="number"==typeof f?f:0,r.acc=Array.isArray(p)&&2==p.length&&"number"==typeof p.reduce((e,t)=>e+t)?p:[0,0],r.isDragged=!1);const e=t.validateEvents(a);t.registerEvents(s,e),y={shape:o,dimensions:n,color:c,physX:r,events:e},t.items.push(y)}}validateEvents(e){const t=[],s=["mousedown","mouseup","mouseover","mouseout","dblclick","click","mousemove","drag"],i=["x","y"];for(let o in e){const n=e[o],{type:r}=n;let{callback:a,assist:c,dragAxis:h,assists:l,bindself:m}=n;const d="string"==typeof r?s.indexOf(r):-1;if(m="boolean"!=typeof m||m,a="function"==typeof a?a:function(){},-1!=d)if(d<7)c="number"==typeof c?c:0,t.push({type:r,assist:c,callback:a,bindself:m});else if(7==d){l=Array.isArray(l)?l:[15,1e3,2e3];let e=[],[s,o,n]=l;switch(s="number"==typeof s?s:15,o="number"==typeof o?o:1e3,n="number"==typeof n?n:2e3,h="string"==typeof h&&i.includes(h)?h:"",e.push({type:"mousedown",assist:s,callback:function(e){this.items[e.id].physX.isDragged=!0,this.disableCursor()}},{type:"mouseup",assist:n,callback:function(e){this.items[e.id].physX.isDragged=!1,this.enableCursor()}}),h){case"x":e.push({type:"mousemove",assist:o,callback:function(e){this.itemIsDragged(e.id)&&this.setItemPos(e.id,{x:this.centerMouseX()})},bindself:!0});break;case"y":e.push({type:"mousemove",assist:o,callback:function(e){this.itemIsDragged(e.id)&&this.setItemPos(e.id,{y:this.centerMouseY()})},bindself:!0});break;default:e.push({type:"mousemove",assist:o,callback:function(e){if(this.itemIsDragged(e.id)){const[t,s]=this.centerMouse();this.setItemPos(e.id,{x:t,y:s})}},bindself:!0})}t.push(...e)}}return t}registerEventType(e){const t=this,s=t.events;"string"==typeof e&&void 0===s[e]&&(t.events[e]=[],t.addHandler(e))}registerEvents(e,t){const s=this,i=t.map(e=>e.type);i.forEach(e=>s.registerEventType(e));for(let o in t){t[o];s.events[i[o]].push([e,o])}}addHandler(e){const t=this,s=t.eventHandler;t.getCanvas().addEventListener(e,s.bind(t))}eventHandler(e){const t=this,s=[e.clientX,e.clientY],i=e.type,o=t.events[i];for(let i in o){const n=o[i][0],r=t.items[n],[a,c]=r.dimensions,h=r.shape,l=r.events[o[i][1]],m="number"==typeof l.assist?l.assist:0;let d,u,f,[p,y]=r.dimensions.slice(2);"arc"==h?(d=[a-p-m,a+p+m],u=[c-p-m,c+p+m],y=p,f=t.checkMouse({mouse:s,shape:h,center:[a,c],radius:p,assist:m})):(d=[a-m,a+p+m],u=[c-m,c+y+m],f=t.checkMouse({mouse:s,shape:h,bordersX:d,bordersY:u})),f&&(e.mouse={x:e.clientX,y:e.clientY},e.dimensions=r.dimensions,e.itemX=a,e.itemY=c,e.width=p,e.height=y,e.shape=h,e.id=n,t._evt=e,0==l.bindself?l.callback():l.callback.call(t,e))}}gravity(){if(!this._isPaused){const e=this,t=e._physX,s=e.fps,[i,o]=e.client,n=(e,[t,s])=>{let i=0;return t>=e?i=-1:s<=e&&(i=1),i};for(let r in t){const a=t[r];if(e.items[a].physX.enable&&!e.itemIsDragged(a)){const t=e.items[a],r=t.physX,{gravity:c,bounce:h,friction:l,acc:m}=r,{shape:d,dimensions:u}=t,[f,p]=u,y=e.speedMult;let b,g,v,I,k=[f,p];if(m[1]+=c/s*y,k[1]+=m[1],m[0]=m[0]*(1-l/100),k[0]+=m[0]/s*y,"arc"==d){const e=t.dimensions[2];b=[e,i-e],g=[e,o-e]}else{const[e,s]=t.dimensions.slice(2);b=[0,i-e],g=[0,o-s]}const M=n(k[0],b),X=n(k[1],g);0!=M&&0==X?(v=-1==M?b[0]:b[1],e.setItemAcc(a,m),e.setItemPos(a,{x:v,y:k[1]}),e.itemHBounce(a)):0!=X&&0==M?(v=-1==X?g[0]:g[1],e.setItemPos(a,{x:k[0],y:v}),e.itemVBounce(a)):0!=M&&0!=X?(v=-1==M?b[0]:b[1],I=-1==X?g[0]:g[1],e.itemHBounce(a),e.itemVBounce(a),e.setItemPos(a,{x:v,y:I})):(e.setItemAcc(a,m),e.setItemPos(a,{x:k[0],y:k[1]}))}else e.setItemAcc(a,[0,0])}}}checkMouse({mouse:e,shape:t,bordersX:s,bordersY:i,center:o,radius:n,assist:r}){if("arc"==t){const t=Math.abs(o[0]-e[0]),s=Math.abs(o[1]-e[1]);return Math.sqrt(t**2+s**2)<=n+(r="number"==typeof r?r:0)}return(([e,t],[s,i],[o,n])=>s<=e&&e<=i&&o<=t&&t<=n)(e,s,i)}drawFrame(){const e=this,t=e.items;if(0==e._isPaused){e.canvasAdapt(),e.drawGrid(),e.gravity();for(let s in t)e.drawItem(s)}}drawGrid(){if(1==this.grid){const e=this,t=e._2D(),{clientWidth:s,clientHeight:i}=e.getCanvas(),o=60,n=Math.ceil(i/o),r=Math.ceil(s/o);let a=o,c=o;t.lineWidth=2,t.strokeStyle="#1a1a1a",t.setLineDash([7,5]);for(let e=1;e<r;e++)t.beginPath(),t.moveTo(a,0),t.lineTo(a,i),t.stroke(),a+=o;for(let e=1;e<n;e++)t.beginPath(),t.moveTo(0,c),t.lineTo(s,c),t.stroke(),c+=o;t.lineWidth=1,t.strokeStyle="",t.setLineDash([])}}clearFrame(){const e=this._2D(),[t,s]=this.client;e.clearRect(0,0,t,s)}canvasAdapt(){const e=this.getCanvas(),{clientWidth:t,clientHeight:s}=e;e.width=t,e.height=s,this.client=[t,s]}drawItem(e){const t=this.items,s=this._2D();if(void 0!==t[e]){const i=t[e],[o,n,r,a,c]=i.dimensions,{shape:h,color:l}=i,{fill:m,stroke:d}=l;switch(s.fillStyle="string"==typeof m?m:"black",s.strokeStyle="string"==typeof d?d:s.fillStyle,h){case"fillRect":s[h](o,n,r,a);break;case"arc":s.beginPath(),s[h](o,n,r,a,c),s.fill(),s.stroke()}}}randomizeItemState(e){const t=this,s=t.items[e],i=[-15,-11,-7,7,11,15],o=[15,20,25,30,35];if("arc"==s.shape){const n=s.dimensions[2],[r,a]=t.client,c=Math.floor(Math.random()*(r-2*n))+n,h=Math.floor(Math.random()*(a-5*n))+3*n,l=Math.floor(1e3*Math.random())+500;t.items[e].physX.gravity=i[Math.floor(Math.random()*i.length)],t.items[e].dimensions[2]=o[Math.floor(Math.random()*o.length)],t.setItemPos(e,{x:c,y:h}),t.setItemHAcc(e,l)}}itemIsDragged(e){return this.items[e].physX.isDragged}setItemPos(e,{x:t,y:s}){this.items[e].dimensions[0]="number"==typeof t?t:this.items[e].dimensions[0],this.items[e].dimensions[1]="number"==typeof s?s:this.items[e].dimensions[1]}setItemColor(e,t){this.items[e].color.fill=t,this.items[e].color.stroke=t}setItemAcc(e,t){this.items[e].physX.acc=t}setItemHAcc(e,t){this.items[e].physX.acc[0]=t}setItemVAcc(e,t){this.items[e].physX.acc[1]=t}itemHBounce(e){this.items[e].physX.acc[0]*=-this.items[e].physX.bounce}itemVBounce(e){this.items[e].physX.acc[1]*=-this.items[e].physX.bounce}setItemRandomColor(e){const t=`rgba(${Math.floor(255*Math.random())},${Math.floor(255*Math.random())},${Math.floor(255*Math.random())},0.4)`;this.setItemFillColor(e,t),this.setItemStrokeColor(e,t)}setItemFillColor(e,t){this.items[e].color.fill=t}setItemStrokeColor(e,t){this.items[e].color.stroke=t}getVar(e){return this._vars[e]}setVar(e,t){this._vars[e]=t}delVar(e){delete this._vars[e]}centerMouseX(){return"arc"==this._evt.shape?this._evt.mouse.x:this._evt.mouse.x-this._evt.width/2}centerMouseY(){return"arc"==this._evt.shape?this._evt.mouse.y:this._evt.mouse.y-this._evt.height/2}centerMouse(){return[this.centerMouseX(),this.centerMouseY()]}disableCursor(){this.getCanvas().style.cursor="none"}enableCursor(){this.getCanvas().style.cursor=""}getCanvas(){return document.getElementById(this.id)}start(){const e=this,t=e.drawFrame;this.drawFrame(),e.refreshFrame=setInterval(function(){t.bind(this)()}.bind(e),1e3/e.fps)}pause(){this._isPaused=!0}unpause(){this._isPaused=!1}stop(){clearInterval(this.refreshFrame),delete this.refreshFrame}}